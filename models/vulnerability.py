"""Vulnerability data model for SecureMySite."""

from dataclasses import dataclass, field
from datetime import datetime
from enum import Enum, auto
from typing import Optional, Dict, Any, List
from pathlib import Path
import uuid


class Severity(Enum):
    """Severity levels for vulnerabilities."""
    CRITICAL = auto()
    HIGH = auto()
    MEDIUM = auto()
    LOW = auto()


class Category(Enum):
    """Vulnerability categories."""
    INJECTION = auto()
    AUTHENTICATION = auto()
    EXPOSURE = auto()
    CONFIGURATION = auto()
    DEPENDENCY = auto()
    TRANSPORT = auto()
    CRYPTOGRAPHY = auto()


@dataclass(frozen=True)
class Vulnerability:
    """
    Unified vulnerability data model.
    
    Attributes:
        id: UUID v4 for unique identification
        title: Human-readable vulnerability title
        description: Detailed explanation of the vulnerability
        severity: Severity level (CRITICAL, HIGH, MEDIUM, LOW)
        category: Vulnerability category
        file_path: Path to affected file
        line_number: Specific line where vulnerability occurs
        column_start: Column range start
        column_end: Column range end
        code_snippet: Affected code (max 5 lines)
        remediation: Instructions on how to fix
        cwe_id: CWE reference (e.g., "CWE-79")
        scanner_source: Which scanner found this issue
        metadata: Scanner-specific additional data
        timestamp: Detection timestamp
    """
    id: str = field(default_factory=lambda: str(uuid.uuid4()))
    title: str
    description: str
    severity: Severity
    category: Category
    file_path: Optional[Path] = None
    line_number: Optional[int] = None
    column_start: Optional[int] = None
    column_end: Optional[int] = None
    code_snippet: Optional[str] = None
    remediation: str
    cwe_id: Optional[str] = None
    scanner_source: str
    metadata: Dict[str, Any] = field(default_factory=dict)
    timestamp: datetime = field(default_factory=datetime.now)
    
    def __post_init__(self):
        """Validate required fields."""
        if not self.title:
            raise ValueError("Title is required")
        if not self.description:
            raise ValueError("Description is required")
        if not self.remediation:
            raise ValueError("Remediation is required")
        if not self.scanner_source:
            raise ValueError("Scanner source is required")
    
    def to_dict(self) -> Dict[str, Any]:
        """Serialize vulnerability to dictionary for JSON export."""
        return {
            'id': self.id,
            'title': self.title,
            'description': self.description,
            'severity': self.severity.name,
            'category': self.category.name,
            'file_path': str(self.file_path) if self.file_path else None,
            'line_number': self.line_number,
            'column_start': self.column_start,
            'column_end': self.column_end,
            'code_snippet': self.code_snippet,
            'remediation': self.remediation,
            'cwe_id': self.cwe_id,
            'scanner_source': self.scanner_source,
            'metadata': self.metadata,
            'timestamp': self.timestamp.isoformat()
        }
    
    @classmethod
    def from_dict(cls, data: Dict[str, Any]) -> 'Vulnerability':
        """Create Vulnerability from dictionary."""
        return cls(
            id=data.get('id', str(uuid.uuid4())),
            title=data['title'],
            description=data['description'],
            severity=Severity[data['severity']],
            category=Category[data['category']],
            file_path=Path(data['file_path']) if data.get('file_path') else None,
            line_number=data.get('line_number'),
            column_start=data.get('column_start'),
            column_end=data.get('column_end'),
            code_snippet=data.get('code_snippet'),
            remediation=data['remediation'],
            cwe_id=data.get('cwe_id'),
            scanner_source=data['scanner_source'],
            metadata=data.get('metadata', {}),
            timestamp=datetime.fromisoformat(data['timestamp']) if data.get('timestamp') else datetime.now()
        )
    
    def __hash__(self) -> int:
        """Enable deduplication based on file+line+title."""
        key = (
            str(self.file_path) if self.file_path else '',
            self.line_number if self.line_number else 0,
            self.title
        )
        return hash(key)
    
    def __eq__(self, other) -> bool:
        """Check equality for deduplication."""
        if not isinstance(other, Vulnerability):
            return False
        return (
            self.file_path == other.file_path and
            self.line_number == other.line_number and
            self.title == other.title
        )
    
    def get_location_string(self) -> str:
        """Get formatted location string."""
        if self.file_path and self.line_number:
            return f"{self.file_path}:{self.line_number}"
        elif self.file_path:
            return str(self.file_path)
        return "Unknown location"
    
    def get_severity_color(self) -> str:
        """Get color code for severity level."""
        colors = {
            Severity.CRITICAL: '#ff4444',
            Severity.HIGH: '#ff8800',
            Severity.MEDIUM: '#ffcc00',
            Severity.LOW: '#00ccff'
        }
        return colors.get(self.severity, '#808080')
